name: Simple CI/CD

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install fastapi uvicorn

    - name: Create simple test
      run: |
        python -c "
        from fastapi import FastAPI
        from fastapi.testclient import TestClient
        app = FastAPI()
        @app.get('/')
        def root(): return {'message': 'Hello'}
        client = TestClient(app)
        response = client.get('/')
        assert response.status_code == 200
        print('âœ… Basic test passed!')
        "

    - name: Notify Telegram - Test Passed
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          âœ… Tests Passed!
          Simple CI/CD is working
          Repository: ${{ github.repository }}

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create simple Dockerfile
      run: |
        cat > Dockerfile << EOF
        FROM python:3.9-slim
        WORKDIR /app
        RUN pip install fastapi uvicorn
        COPY app.py .
        CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
        EOF

    - name: Create app.py
      run: |
        cat > app.py << EOF
        from fastapi import FastAPI
        app = FastAPI()
        @app.get("/")
        def read_root():
            return {"Hello": "World", "from": "CI/CD"}
        @app.get("/health")
        def health():
            return {"status": "healthy"}
        EOF

    - name: Build Docker image
      run: |
        docker build -t therealmak/simple-app:latest .
        echo "âœ… Docker image built locally!"

    - name: Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Push to Docker Hub
      run: |
        docker push therealmak/simple-app:latest

    - name: Notify Telegram - Build Success
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ðŸ³ Docker Image Pushed!
          âœ… therealmak/simple-app:latest
          ðŸ“¦ Successfully deployed to Docker Hub
          ðŸ”— https://hub.docker.com/r/therealmak/simple-app
